#include "keccak/config.h"
#include "keccak/keccak/keccak-1600.h"
#include "keccak/keccak/keccakp-1600.h"

#include <stdint.h>
#include <stdlib.h>

#define rol(UINT64, ROL) ((UINT64 << ROL) | (UINT64 >> (64 - ROL)))

static KINLINE int _keccakp(register uint64_t* const restrict A,
                            register const uint8_t rounds) {
  register uint64_t B[25] = {0};
  register uint64_t C[5] = {0};
  register uint64_t D[5] = {0};
  register uint64_t E[25] = {0};

  if ((rounds > 24) || ((rounds & 1) != 0)) {
    return -1;
  }

  // Early parity.
  C[0] = A[0] ^ A[5] ^ A[10] ^ A[15] ^ A[20];
  C[1] = A[1] ^ A[6] ^ A[11] ^ A[16] ^ A[21];
  C[2] = A[2] ^ A[7] ^ A[12] ^ A[17] ^ A[22];
  C[3] = A[3] ^ A[8] ^ A[13] ^ A[18] ^ A[23];
  C[4] = A[4] ^ A[9] ^ A[14] ^ A[19] ^ A[24];

  for (uint8_t i = (24 - rounds); i < rounds; i += 2) {
    // round i: A -> E
    D[0] = C[4] ^ rol(C[1], 1);
    D[1] = C[0] ^ rol(C[2], 1);
    D[2] = C[1] ^ rol(C[3], 1);
    D[3] = C[2] ^ rol(C[4], 1);
    D[4] = C[3] ^ rol(C[0], 1);

    A[0] ^= D[0];
    B[0] = A[0];
    A[6] ^= D[1];
    B[1] = ((((uint64_t)A[6]) << 44) ^ (((uint64_t)A[6]) >> (64 - 44)));
    A[12] ^= D[2];
    B[2] = ((((uint64_t)A[12]) << 43) ^ (((uint64_t)A[12]) >> (64 - 43)));
    A[18] ^= D[3];
    B[3] = ((((uint64_t)A[18]) << 21) ^ (((uint64_t)A[18]) >> (64 - 21)));
    A[24] ^= D[4];
    B[4] = ((((uint64_t)A[24]) << 14) ^ (((uint64_t)A[24]) >> (64 - 14)));
    E[0] = B[0] ^ ((~B[1]) & B[2]);

    E[0] ^= round_constants[i];
    C[0] = E[0];
    E[1] = B[1] ^ ((~B[2]) & B[3]);
    C[1] = E[1];
    E[2] = B[2] ^ ((~B[3]) & B[4]);
    C[2] = E[2];
    E[3] = B[3] ^ ((~B[4]) & B[0]);
    C[3] = E[3];
    E[4] = B[4] ^ ((~B[0]) & B[1]);
    C[4] = E[4];

    A[3] ^= D[3];
    B[5] = ((((uint64_t)A[3]) << 28) ^ (((uint64_t)A[3]) >> (64 - 28)));
    A[9] ^= D[4];
    B[6] = ((((uint64_t)A[9]) << 20) ^ (((uint64_t)A[9]) >> (64 - 20)));
    A[10] ^= D[0];
    B[7] = ((((uint64_t)A[10]) << 3) ^ (((uint64_t)A[10]) >> (64 - 3)));
    A[16] ^= D[1];
    B[8] = ((((uint64_t)A[16]) << 45) ^ (((uint64_t)A[16]) >> (64 - 45)));
    A[22] ^= D[2];
    B[9] = ((((uint64_t)A[22]) << 61) ^ (((uint64_t)A[22]) >> (64 - 61)));

    E[5] = B[5] ^ ((~B[6]) & B[7]);
    C[0] ^= E[5];
    E[6] = B[6] ^ ((~B[7]) & B[8]);
    C[1] ^= E[6];
    E[7] = B[7] ^ ((~B[8]) & B[9]);
    C[2] ^= E[7];
    E[8] = B[8] ^ ((~B[9]) & B[5]);
    C[3] ^= E[8];
    E[9] = B[9] ^ ((~B[5]) & B[6]);
    C[4] ^= E[9];
    A[1] ^= D[1];
    B[10] = ((((uint64_t)A[1]) << 1) ^ (((uint64_t)A[1]) >> (64 - 1)));
    A[7] ^= D[2];
    B[11] = ((((uint64_t)A[7]) << 6) ^ (((uint64_t)A[7]) >> (64 - 6)));
    A[13] ^= D[3];
    B[12] = ((((uint64_t)A[13]) << 25) ^ (((uint64_t)A[13]) >> (64 - 25)));
    A[19] ^= D[4];
    B[13] = ((((uint64_t)A[19]) << 8) ^ (((uint64_t)A[19]) >> (64 - 8)));
    A[20] ^= D[0];
    B[14] = ((((uint64_t)A[20]) << 18) ^ (((uint64_t)A[20]) >> (64 - 18)));
    E[10] = B[10] ^ ((~B[11]) & B[12]);
    C[0] ^= E[10];
    E[11] = B[11] ^ ((~B[12]) & B[13]);
    C[1] ^= E[11];
    E[12] = B[12] ^ ((~B[13]) & B[14]);
    C[2] ^= E[12];
    E[13] = B[13] ^ ((~B[14]) & B[10]);
    C[3] ^= E[13];
    E[14] = B[14] ^ ((~B[10]) & B[11]);
    C[4] ^= E[14];
    A[4] ^= D[4];
    B[15] = ((((uint64_t)A[4]) << 27) ^ (((uint64_t)A[4]) >> (64 - 27)));
    A[5] ^= D[0];
    B[16] = ((((uint64_t)A[5]) << 36) ^ (((uint64_t)A[5]) >> (64 - 36)));
    A[11] ^= D[1];
    B[17] = ((((uint64_t)A[11]) << 10) ^ (((uint64_t)A[11]) >> (64 - 10)));
    A[17] ^= D[2];
    B[18] = ((((uint64_t)A[17]) << 15) ^ (((uint64_t)A[17]) >> (64 - 15)));
    A[23] ^= D[3];
    B[19] = ((((uint64_t)A[23]) << 56) ^ (((uint64_t)A[23]) >> (64 - 56)));
    E[15] = B[15] ^ ((~B[16]) & B[17]);
    C[0] ^= E[15];
    E[16] = B[16] ^ ((~B[17]) & B[18]);
    C[1] ^= E[16];
    E[17] = B[17] ^ ((~B[18]) & B[19]);
    C[2] ^= E[17];
    E[18] = B[18] ^ ((~B[19]) & B[15]);
    C[3] ^= E[18];
    E[19] = B[19] ^ ((~B[15]) & B[16]);
    C[4] ^= E[19];
    A[2] ^= D[2];
    B[20] = ((((uint64_t)A[2]) << 62) ^ (((uint64_t)A[2]) >> (64 - 62)));
    A[8] ^= D[3];
    B[21] = ((((uint64_t)A[8]) << 55) ^ (((uint64_t)A[8]) >> (64 - 55)));
    A[14] ^= D[4];
    B[22] = ((((uint64_t)A[14]) << 39) ^ (((uint64_t)A[14]) >> (64 - 39)));
    A[15] ^= D[0];
    B[23] = ((((uint64_t)A[15]) << 41) ^ (((uint64_t)A[15]) >> (64 - 41)));
    A[21] ^= D[1];
    B[24] = ((((uint64_t)A[21]) << 2) ^ (((uint64_t)A[21]) >> (64 - 2)));
    E[20] = B[20] ^ ((~B[21]) & B[22]);
    C[0] ^= E[20];
    E[21] = B[21] ^ ((~B[22]) & B[23]);
    C[1] ^= E[21];
    E[22] = B[22] ^ ((~B[23]) & B[24]);
    C[2] ^= E[22];
    E[23] = B[23] ^ ((~B[24]) & B[20]);
    C[3] ^= E[23];
    E[24] = B[24] ^ ((~B[20]) & B[21]);
    C[4] ^= E[24];

    // round i + 1; E -> A
    D[0] = C[4] ^ ((((uint64_t)C[1]) << 1) ^ (((uint64_t)C[1]) >> (64 - 1)));
    D[1] = C[0] ^ ((((uint64_t)C[2]) << 1) ^ (((uint64_t)C[2]) >> (64 - 1)));
    D[2] = C[1] ^ ((((uint64_t)C[3]) << 1) ^ (((uint64_t)C[3]) >> (64 - 1)));
    D[3] = C[2] ^ ((((uint64_t)C[4]) << 1) ^ (((uint64_t)C[4]) >> (64 - 1)));
    D[4] = C[3] ^ ((((uint64_t)C[0]) << 1) ^ (((uint64_t)C[0]) >> (64 - 1)));
    E[0] ^= D[0];
    B[0] = E[0];
    E[6] ^= D[1];
    B[1] = ((((uint64_t)E[6]) << 44) ^ (((uint64_t)E[6]) >> (64 - 44)));
    E[12] ^= D[2];
    B[2] = ((((uint64_t)E[12]) << 43) ^ (((uint64_t)E[12]) >> (64 - 43)));
    E[18] ^= D[3];
    B[3] = ((((uint64_t)E[18]) << 21) ^ (((uint64_t)E[18]) >> (64 - 21)));
    E[24] ^= D[4];
    B[4] = ((((uint64_t)E[24]) << 14) ^ (((uint64_t)E[24]) >> (64 - 14)));
    A[0] = B[0] ^ ((~B[1]) & B[2]);
    A[0] ^= round_constants[i + 1];
    C[0] = A[0];
    A[1] = B[1] ^ ((~B[2]) & B[3]);
    C[1] = A[1];
    A[2] = B[2] ^ ((~B[3]) & B[4]);
    C[2] = A[2];
    A[3] = B[3] ^ ((~B[4]) & B[0]);
    C[3] = A[3];
    A[4] = B[4] ^ ((~B[0]) & B[1]);
    C[4] = A[4];
    E[3] ^= D[3];
    B[5] = ((((uint64_t)E[3]) << 28) | (((uint64_t)E[3]) >> (64 - 28)));
    E[9] ^= D[4];
    B[6] = ((((uint64_t)E[9]) << 20) | (((uint64_t)E[9]) >> (64 - 20)));
    E[10] ^= D[0];
    B[7] = ((((uint64_t)E[10]) << 3) | (((uint64_t)E[10]) >> (64 - 3)));
    E[16] ^= D[1];
    B[8] = ((((uint64_t)E[16]) << 45) | (((uint64_t)E[16]) >> (64 - 45)));
    E[22] ^= D[2];
    B[9] = ((((uint64_t)E[22]) << 61) | (((uint64_t)E[22]) >> (64 - 61)));
    A[5] = B[5] ^ ((~B[6]) & B[7]);
    C[0] ^= A[5];
    A[6] = B[6] ^ ((~B[7]) & B[8]);
    C[1] ^= A[6];
    A[7] = B[7] ^ ((~B[8]) & B[9]);
    C[2] ^= A[7];
    A[8] = B[8] ^ ((~B[9]) & B[5]);
    C[3] ^= A[8];
    A[9] = B[9] ^ ((~B[5]) & B[6]);
    C[4] ^= A[9];
    E[1] ^= D[1];
    B[10] = ((((uint64_t)E[1]) << 1) | (((uint64_t)E[1]) >> (64 - 1)));
    E[7] ^= D[2];
    B[11] = ((((uint64_t)E[7]) << 6) | (((uint64_t)E[7]) >> (64 - 6)));
    E[13] ^= D[3];
    B[12] = ((((uint64_t)E[13]) << 25) | (((uint64_t)E[13]) >> (64 - 25)));
    E[19] ^= D[4];
    B[13] = ((((uint64_t)E[19]) << 8) | (((uint64_t)E[19]) >> (64 - 8)));
    E[20] ^= D[0];
    B[14] = ((((uint64_t)E[20]) << 18) | (((uint64_t)E[20]) >> (64 - 18)));
    A[10] = B[10] ^ ((~B[11]) & B[12]);
    C[0] ^= A[10];
    A[11] = B[11] ^ ((~B[12]) & B[13]);
    C[1] ^= A[11];
    A[12] = B[12] ^ ((~B[13]) & B[14]);
    C[2] ^= A[12];
    A[13] = B[13] ^ ((~B[14]) & B[10]);
    C[3] ^= A[13];
    A[14] = B[14] ^ ((~B[10]) & B[11]);
    C[4] ^= A[14];
    E[4] ^= D[4];
    B[15] = ((((uint64_t)E[4]) << 27) | (((uint64_t)E[4]) >> (64 - 27)));
    E[5] ^= D[0];
    B[16] = ((((uint64_t)E[5]) << 36) | (((uint64_t)E[5]) >> (64 - 36)));
    E[11] ^= D[1];
    B[17] = ((((uint64_t)E[11]) << 10) | (((uint64_t)E[11]) >> (64 - 10)));
    E[17] ^= D[2];
    B[18] = ((((uint64_t)E[17]) << 15) | (((uint64_t)E[17]) >> (64 - 15)));
    E[23] ^= D[3];
    B[19] = ((((uint64_t)E[23]) << 56) | (((uint64_t)E[23]) >> (64 - 56)));
    A[15] = B[15] ^ ((~B[16]) & B[17]);
    C[0] ^= A[15];
    A[16] = B[16] ^ ((~B[17]) & B[18]);
    C[1] ^= A[16];
    A[17] = B[17] ^ ((~B[18]) & B[19]);
    C[2] ^= A[17];
    A[18] = B[18] ^ ((~B[19]) & B[15]);
    C[3] ^= A[18];
    A[19] = B[19] ^ ((~B[15]) & B[16]);
    C[4] ^= A[19];
    E[2] ^= D[2];
    B[20] = ((((uint64_t)E[2]) << 62) | (((uint64_t)E[2]) >> (64 - 62)));
    E[8] ^= D[3];
    B[21] = ((((uint64_t)E[8]) << 55) | (((uint64_t)E[8]) >> (64 - 55)));
    E[14] ^= D[4];
    B[22] = ((((uint64_t)E[14]) << 39) | (((uint64_t)E[14]) >> (64 - 39)));
    E[15] ^= D[0];
    B[23] = ((((uint64_t)E[15]) << 41) | (((uint64_t)E[15]) >> (64 - 41)));
    E[21] ^= D[1];
    B[24] = ((((uint64_t)E[21]) << 2) | (((uint64_t)E[21]) >> (64 - 2)));
    A[20] = B[20] ^ ((~B[21]) & B[22]);
    C[0] ^= A[20];
    A[21] = B[21] ^ ((~B[22]) & B[23]);
    C[1] ^= A[21];
    A[22] = B[22] ^ ((~B[23]) & B[24]);
    C[2] ^= A[22];
    A[23] = B[23] ^ ((~B[24]) & B[20]);
    C[3] ^= A[23];
    A[24] = B[24] ^ ((~B[20]) & B[21]);
    C[4] ^= A[24];
  }
  return 0;
}

KINLINE void _keccakf_aligned(uint64_t* const A) {
  _keccakp(A, 24);
}
